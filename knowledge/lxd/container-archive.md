LXDコンテナのアーカイブ化とそのインポート
====================================================

チーム毎の開発環境を整える際ansibleなどでリアルタイムに整える方法もありますが  
今回の方法はLXDのコンテナをイメージ化し、アーカイブファイルで共有する方法です。  
vagrantで既存のboxを手元にコピーし、vagrant upするのとイメージは同じです。


## まずはコンテナのイメージ化
既存のコンテナをまずイメージに落とし込みます。このイメージを後ほどアーカイブファイルに変換します。

+ 既存のコンテナ一覧表示。webサーバーとして構築済みのコンテナです。
 + $ lxc list
```
+-------+---------+------------------+------+------------+-----------+
| NAME  |  STATE  |       IPV4       | IPV6 |    TYPE    | SNAPSHOTS |
+-------+---------+------------------+------+------------+-----------+
| web01 | RUNNING | 10.0.0.11 (eth0) |      | PERSISTENT | 0         |
+-------+---------+------------------+------+------------+-----------+
```

+ web01をwebというaliasでイメージ化
+ 必須ではありませんがaliasは付けておかないと、フィンガープリントをコピペする作業が発生しますし、イメージが増えてくると何が何だかわからなくなるので、理由が無い限りは付けましょう。
 + $ lxc publish web01 --alias web
 + $ lxc image list
```
+--------+--------------+--------+---------------------------------------------+--------+----------+------------------------------+
| ALIAS  | FINGERPRINT  | PUBLIC |                 DESCRIPTION                 |  ARCH  |   SIZE   |         UPLOAD DATE          |
+--------+--------------+--------+---------------------------------------------+--------+----------+------------------------------+
| web    | 8fe98e75c1e1 | no     |                                             | x86_64 | 244.05MB | Mar 2, 2017 at 5:50pm (UTC)  |
+--------+--------------+--------+---------------------------------------------+--------+----------+------------------------------+
| xenial | 96e12fc44b24 | no     | ubuntu 16.04 LTS amd64 (release) (20170224) | x86_64 | 146.50MB | Feb 28, 2017 at 6:17pm (UTC) |
+--------+--------------+--------+---------------------------------------------+--------+----------+------------------------------+
```
+ webというイメージが作成出来た事が確認できました。


## イメージのアーカイブを作成する
作成したイメージを扱いやすいように、アーカイブファイルとして保存します。  
そうしておくと、ファイルサーバーで共有しやすいので何かと便利です。

+ webイメージをアーカイブ化する
 + $ lxc image export local:web ~/image_archives/web
 + $ ll ~/image_archives
```
drwxrwxr-x  2 vjsigsig vjsigsig 4096  3月  3 03:00 ./
drwxr-xr-x 28 vjsigsig vjsigsig 4096  3月  3 02:59 ../
-rw-------  1 vjsigsig vjsigsig 245M  3月  3 03:00 web.tar.gz
```
+ webイメージのtarballが作成されている事が確認できました。  
+ こいつをファイルサーバーに入れて共有することが可能です。


## アーカイブファイルからイメージを作成する
先程の逆で、アーカイブ化したイメージを復元します。  
チームに新たなメンバーを迎えた時などに行ってもらう手順になります。  
まずはファイルサーバーからアーカイブファイルを手元に持ってきてもらいましょう。

+ ここからは↑の手順とは別の開発マシンを想定。LXDをインストールしてグループ設定をした直後と仮定します。
 + $ lxc image list
```
+-------+-------------+--------+-------------+------+------+-------------+
| ALIAS | FINGERPRINT | PUBLIC | DESCRIPTION | ARCH | SIZE | UPLOAD DATE |
+-------+-------------+--------+-------------+------+------+-------------+
```
+ ひとまずなーんもイメージが無い事を確認。

+ アーカイブファイルからイメージを作成する
+ aliasは特に理由が無ければ、アーカイブ前のイメージのaliasと同じ。もしくは拡張子前のファイル名とした方が良いです。
+ 「ファイル名とイメージ名が違う場合あるじゃん！！」　せやな。そこは運用でカバーで（・∀・）
 + $ lxc image import ~/Download/web.tar.gz --alias web
 + $ lxc image list
```
+-------+--------------+--------+------------------------------------+--------+----------+-----------------------------+
| ALIAS | FINGERPRINT  | PUBLIC |            DESCRIPTION             |  ARCH  |   SIZE   |         UPLOAD DATE         |
+-------+--------------+--------+------------------------------------+--------+----------+-----------------------------+
| web   | 8fe98e75c1e1 | no     | Ubuntu 16.04 LTS server (20170224) | x86_64 | 244.05MB | Mar 2, 2017 at 6:18pm (UTC) |
+-------+--------------+--------+------------------------------------+--------+----------+-----------------------------+
```
+ 無事、イメージが作成されている事が確認出来ました。

